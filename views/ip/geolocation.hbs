{{> above}}
<div class="alert alert-info">Geolocating an IP address is not an exact science.  It depends on data collected (or volunteered
    by the community), and needs constant updates.
</div>

<h2>Results for {{ip}}</h2>

<p>ASN: {{asn}} <!--LATER: link to asn page --></p>

<table class="table table-striped border-bottom">
    <thead>
        <tr>
            <th>Provider</th>
            <th>Version</th>
            <th>Results</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><a href="https://dev.maxmind.com/geoip/geoip2/geolite2/">Maxmind</a></td>
            <td>{{maxmind_version}}</td>
            <td>{{{maxmind}}}</td>
        </tr>
        <tr>
            <td><a href="http://www.hostip.info/use.php">HostIP.info</a></td>
            <td><i>(online service)</i></td>
            <td id="hostipinfo">Pending...</td>
        </tr>
        <tr>
            <td><a href="https://ipgeolocation.io/">ipgeolocation</a></td>
            <td><i>(online service)</i></td>
            <td id="ipgeolocation">Pending...</td>
        </tr>
    </tbody>
</table>

<h2>Specific IP</h2>

<form action="geolocation.html" method="GET">
<div class="row">
    <div class="col d-flex justify-content-center">
    <div class="card col-lg-5 px-0">
        <div class="card-body">
            <h5 class="card-title text-center">IP Geolocation</h5>
            <div class="form-group">
                <label for="ip">IP Address</label>
                <input type="text" class="form-control" id="ip" name="ip" value="{{ip}}" />
            </div>
            <input class="btn btn-primary" type="submit" value="Locate" />
        </div>
    </div>
    </div>
</div>
</form>

<hr/>

<h2>Other IP Geolocation Databases</h2>

<div class="alert alert-info">
    Note: all pricing is for the lowest service level possible. They all have higher priced options (of course).
</div>

<ul>
    <li><a href="https://www.maxmind.com/en/geoip2-precision-services">MaxMind</a> - in addition to their free offering (used above), they have a commercial service that starts at $0.10 per 1,000 lookups.</li>
    <li><a href="https://ipgeolocation.io/pricing.html">ipgeolocation.io</a> - 1,000/day free.  $15/month for 150,000</li>
    <li><a href="http://www.ip2nation.com/">ip2nation</a> - free, only gets the country (which is often good enough!)</li>
    <li><a href="https://www.ip2location.com/">IP2Location</a> - $49 for 100,000 lookups.  They also sell their database(s) for local use.</li>
    <li>Neustar's <a href="https://www.home.neustar/security-intelligence/ip-geopoint">UltraGeoPoint</a> - no pricing on website</li>
    <li>Cyscape's <a href="http://www.cyscape.com/products/chawk/">CountryHawk</a> - $669 per server per year</li>
    <li><a href="http://www.atelierweb.com/products/ip-locator/">Atelier Web IP Locator</a> - $40 for 50,000 lookups.  Free plan is 200 per 30 days.</li>
</ul>

<h3>Internet Governing Bodies</h3>
<ul>
    <li><a href="https://search.arin.net/rdap/">ARIN Whois/RDAP lookup</a></li>
    <li><a href="https://apps.db.ripe.net/db-web-ui/query">RIPE Database Query</a></li>
    <li><a href="https://afrinic.net/whois-web/public/query">AFRINIC Query</a></li>
</ul>

<script>
    async function hostIpInfo(ip) {
        const el = document.getElementById('hostipinfo')
        try {
            el.innerText = 'Loading...';
            const response = await fetch(`https://api.hostip.info/get_json.php?ip=${encodeURIComponent(ip)}&position=true`, {
                referrerPolicy: ''
                });
            if (!response.ok) { 
                el.innerText = `ERROR ${response.status}: ${response.statusText}`;
                return;
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                el.innerText = `ERROR non-json response (${contentType})`;
                return;
            }
            const result = await response.json();
            console.log(`hostip.info result = ${JSON.stringify(result)}`);
            el.innerText = `${result.country || '(no city)'}, ${result.country || '(no country)'}: ${result.latitude || '(no latitude)'},${result.longitude || '(no longitude)'}`;
        } catch (err) {
            el.innerText = `ERROR ${err.message}`;
        }
    }

    async function ipGeoLocation(ip) {
        const el = document.getElementById('ipgeolocation')
        {{#if ipgeolocation_api_key}}
        try {
            el.innerText = 'Loading...';
            const response = await fetch(`https://api.ipgeolocation.io/ipgeo?apiKey={{ipgeolocation_api_key}}&ip=${encodeURIComponent(ip)}&position=true`, {
                referrerPolicy: ''
                });
            if (!response.ok) { 
                el.innerText = `ERROR ${response.status}: ${response.statusText}`;
                return;
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                el.innerText = `ERROR non-json response (${contentType})`;
                return;
            }
            const result = await response.json();
            console.log(`ipgeolocation.io result = ${JSON.stringify(result)}`);
            el.innerText = `${result.country || '(no city)'}, ${result.country || '(no country)'}: ${result.latitude || '(no latitude)'},${result.longitude || '(no longitude)'}`;
        } catch (err) {
            el.innerText = `ERROR ${err.message}`;
        }
        {{else}}
            el.innerText = 'ERROR: server is not configured with an API key';
        {{/if}}
    }

    hostIpInfo("{{ip}}");
    ipGeoLocation("{{ip}}");
</script>

{{> below}}
